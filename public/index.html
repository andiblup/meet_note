<!DOCTYPE html>
<html lang="de" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Meet¬†Note ‚Äì¬†Editor</title>

    <link rel="stylesheet" href="./styles/output.css">
    <link rel="stylesheet" href="./vendors/prism.min.css">
    <script src="./vendors/prism.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="node_modules/boxicons/css/boxicons.min.css" rel="stylesheet">
    <!-- <link href="../node_modules/prismjs/components/prism-java.min.js" rel="stylesheet"> -->


</head>

<body class="bg-base-200 min-h-screen flex">


    <!-- Toast-Container -->
    <div id="toast-wrapper" class="toast toast-end">

    </div>

    <!-- Sidebar -->
    <input id="sideToggle" type="checkbox" class="drawer-toggle hidden" />
    <aside class="drawer-side z-50">
        <label for="sideToggle" class="drawer-overlay"></label>
        <div class="w-72 bg-base-100 p-4 flex flex-col space-y-4">
            <h2 class="text-lg font-bold"><i class='bx bx-folder-open'></i> Dateien</h2>
            <!-- <h2 class="text-lg font-bold">üìÇ Dateien</h2> -->
            <ul id="fileList" style="width: 100%;" class="menu w-100 bg-base-200 rounded-box flex-1 overflow-auto"></ul>
            <div class="space-y-2">
                <input id="newFileName" class="input input-bordered w-full" placeholder="Neuer Dateiname‚Ä¶">
                <div class="flex gap-2">
                    <button id="btnAdd" class="btn btn-primary btn-sm flex-1"><i class='bx bx-plus'></i></button>
                    <button id="btnRename" class="btn btn-outline btn-sm"><i class='bx bx-edit'></i></button>
                    <button id="btnDelete" class="btn btn-error btn-sm"><i class='bx bxs-trash'></i></button>
                    <!-- <button id="btnAdd" class="btn btn-primary btn-sm flex-1">‚ûï</button>
                    <button id="btnRename" class="btn btn-outline btn-sm">‚úèÔ∏è</button>
                    <button id="btnDelete" class="btn btn-error btn-sm">üóëÔ∏è</button> -->
                </div>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <div class="flex-1 flex flex-col">

        <!-- Toolbar/Header -->
        <!-- <nav class="navbar bg-base-100 sticky top-0 z-50 shadow-md"> -->
        <nav class="navbar sticky shadow-md bg-base-100 px-4 shadow flex flex-wrap items-center gap-2">
            <!-- <label for="sideToggle" class="btn btn-square btn-ghost"><i class='bx bx-folder'></i></label>
            <button id="btnNote" class="btn btn-sm btn-ghost btn-active"><i class='bx bx-note' ></i></button>
            <button id="btnCheck" class="btn btn-sm btn-ghost"><i class='bx bx-checkbox-checked' ></i></button>
            <button id="btnAddBlock" class="btn btn-sm btn-ghost"><i class='bx bx-plus' ></i></button> -->

            <!-- <label for="sideToggle" class="btn btn-square btn-ghost">üìÅ</label>
            <button id="btnNote" class="btn btn-sm btn-ghost btn-active">üìù</button>
            <button id="btnCheck" class="btn btn-sm btn-ghost">‚òëÔ∏è</button>
            <button id="btnCode" class="btn btn-sm btn-ghost">üíª</button>
            <button id="btnAddBlock" class="btn btn-sm btn-ghost">‚ûï</button> -->
            <!-- <div class="divider divider-horizontal m-0"></div> -->

            <div id="toolbar" class="flex flex-wrap gap-2 items-center">

                <label for="sideToggle" class="btn btn-square btn-ghost"><i class='bx bx-folder'></i></label>
                <button id="btnSettings" class="btn btn-ghost btn-sm"><i class='bx bx-cog'></i></button>
                <button id="btnNote" class="btn btn-sm btn-ghost btn-active"><i class='bx bx-note'></i></button>
                <button id="btnCheck" class="btn btn-sm btn-ghost"><i class='bx bx-checkbox-checked'></i></button>
                <button id="btnAddBlock" class="btn btn-sm btn-ghost"><i class='bx bx-plus'></i></button>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Format -->
                <button data-cmd="bold" class="btn btn-sm btn-ghost" title="Fett (Ctrl+B)"><i
                        class="bx bx-bold"></i></button>
                <button data-cmd="italic" class="btn btn-sm btn-ghost" title="Kursiv (Ctrl+I)"><i
                        class="bx bx-italic"></i></button>
                <button data-cmd="underline" class="btn btn-sm btn-ghost" title="Unterstrichen"><i
                        class="bx bx-underline"></i></button>
                <button data-cmd="strikeThrough" class="btn btn-sm btn-ghost" title="Durchgestrichen"><i
                        class="bx bx-strikethrough"></i></button>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Headings -->
                <select id="selHeading" class="select select-sm" title="√úberschrift">
                    <option value="p">Text</option>
                    <option value="h1">H1</option>
                    <option value="h2">H2</option>
                    <option value="h3">H3</option>
                </select>

                <!-- Schriftgr√∂√üe -->
                <select id="selFontSize" class="select select-sm" title="Schriftgr√∂√üe">
                    <option value="1">xs</option>
                    <option value="2">sm</option>
                    <option value="3" selected>base</option>
                    <option value="4">lg</option>
                    <option value="5">xl</option>
                    <option value="6">2xl</option>
                </select>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Listen -->
                <button data-cmd="insertUnorderedList" class="btn btn-sm btn-ghost" title="Aufz√§hlung"><i
                        class="bx bx-list-ul"></i></button>
                <button data-cmd="insertOrderedList" class="btn btn-sm btn-ghost" title="Nummerierte Liste"><i
                        class="bx bx-list-ol"></i></button>
                <button id="btnCheckboxList" class="btn btn-sm btn-ghost" title="Checkbox‚ÄëListe"><i
                        class="bx bx-checkbox"></i></button>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Ausrichtung -->
                <button data-cmd="justifyLeft" class="btn btn-sm btn-ghost" title="Linksb√ºndig"><i
                        class="bx bx-align-left"></i></button>
                <button data-cmd="justifyCenter" class="btn btn-sm btn-ghost" title="Zentriert"><i
                        class="bx bx-align-middle"></i></button>
                <button data-cmd="justifyRight" class="btn btn-sm btn-ghost" title="Rechtsb√ºndig"><i
                        class="bx bx-align-right"></i></button>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Textfarben -->
                <select id="selForeColor" class="select select-sm" title="Text‚ÄëFarbe">
                    <option value="">Textfarbe</option>
                    <optgroup label="slate">
                        <option value="#cbd5e1">‚ñ† slate-300</option>
                        <option value="#64748b">‚ñ† slate-500</option>
                        <option value="#0f172a">‚ñ† slate-700</option>
                    </optgroup>
                    <optgroup label="gray">
                        <option value="#d1d5db">‚ñ† gray-300</option>
                        <option value="#6b7280">‚ñ† gray-500</option>
                        <option value="#111827">‚ñ† gray-700</option>
                    </optgroup>
                    <optgroup label="red">
                        <option value="#fecdd3">‚ñ† red-300</option>
                        <option value="#ef4444">‚ñ† red-500</option>
                        <option value="#991b1b">‚ñ† red-700</option>
                    </optgroup>
                    <optgroup label="orange">
                        <option value="#fed7aa">‚ñ† orange-300</option>
                        <option value="#f97316">‚ñ† orange-500</option>
                        <option value="#c2410c">‚ñ† orange-700</option>
                    </optgroup>
                    <optgroup label="amber">
                        <option value="#fde68a">‚ñ† amber-300</option>
                        <option value="#f59e0b">‚ñ† amber-500</option>
                        <option value="#92400e">‚ñ† amber-700</option>
                    </optgroup>
                    <optgroup label="yellow">
                        <option value="#fef08a">‚ñ† yellow-300</option>
                        <option value="#eab308">‚ñ† yellow-500</option>
                        <option value="#713f12">‚ñ† yellow-700</option>
                    </optgroup>
                    <optgroup label="lime">
                        <option value="#d9f99d">‚ñ† lime-300</option>
                        <option value="#84cc16">‚ñ† lime-500</option>
                        <option value="#365314">‚ñ† lime-700</option>
                    </optgroup>
                    <optgroup label="green">
                        <option value="#bbf7d0">‚ñ† green-300</option>
                        <option value="#22c55e">‚ñ† green-500</option>
                        <option value="#166534">‚ñ† green-700</option>
                    </optgroup>
                    <optgroup label="emerald">
                        <option value="#6ee7b7">‚ñ† emerald-300</option>
                        <option value="#10b981">‚ñ† emerald-500</option>
                        <option value="#064e3b">‚ñ† emerald-700</option>
                    </optgroup>
                    <optgroup label="teal">
                        <option value="#5eead4">‚ñ† teal-300</option>
                        <option value="#14b8a6">‚ñ† teal-500</option>
                        <option value="#0f766e">‚ñ† teal-700</option>
                    </optgroup>
                    <optgroup label="cyan">
                        <option value="#67e8f9">‚ñ† cyan-300</option>
                        <option value="#06b6d4">‚ñ† cyan-500</option>
                        <option value="#164e63">‚ñ† cyan-700</option>
                    </optgroup>
                    <optgroup label="sky">
                        <option value="#7dd3fc">‚ñ† sky-300</option>
                        <option value="#0ea5e9">‚ñ† sky-500</option>
                        <option value="#075985">‚ñ† sky-700</option>
                    </optgroup>
                    <optgroup label="blue">
                        <option value="#93c5fd">‚ñ† blue-300</option>
                        <option value="#3b82f6">‚ñ† blue-500</option>
                        <option value="#1e40af">‚ñ† blue-700</option>
                    </optgroup>
                    <optgroup label="indigo">
                        <option value="#a5b4fc">‚ñ† indigo-300</option>
                        <option value="#6366f1">‚ñ† indigo-500</option>
                        <option value="#312e81">‚ñ† indigo-700</option>
                    </optgroup>
                    <optgroup label="violet">
                        <option value="#c4b5fd">‚ñ† violet-300</option>
                        <option value="#8b5cf6">‚ñ† violet-500</option>
                        <option value="#5b21b6">‚ñ† violet-700</option>
                    </optgroup>
                    <optgroup label="purple">
                        <option value="#d8b4fe">‚ñ† purple-300</option>
                        <option value="#a855f7">‚ñ† purple-500</option>
                        <option value="#6b21a8">‚ñ† purple-700</option>
                    </optgroup>
                    <optgroup label="fuchsia">
                        <option value="#fbcfe8">‚ñ† fuchsia-300</option>
                        <option value="#d946ef">‚ñ† fuchsia-500</option>
                        <option value="#831843">‚ñ† fuchsia-700</option>
                    </optgroup>
                    <optgroup label="pink">
                        <option value="#f9a8d4">‚ñ† pink-300</option>
                        <option value="#ec4899">‚ñ† pink-500</option>
                        <option value="#9d174d">‚ñ† pink-700</option>
                    </optgroup>
                    <optgroup label="rose">
                        <option value="#fecdd3">‚ñ† rose-300</option>
                        <option value="#f43f5e">‚ñ† rose-500</option>
                        <option value="#881337">‚ñ† rose-700</option>
                    </optgroup>
                </select>

                <!-- Hintergrund -->
                <select id="selBackColor" class="select select-sm" title="Hintergrund‚ÄëFarbe">
                    <option value="">Hintergrund</option>
                    <optgroup label="slate">
                        <option value="#cbd5e1">‚ñ† slate-300</option>
                        <option value="#64748b">‚ñ† slate-500</option>
                        <option value="#0f172a">‚ñ† slate-700</option>
                    </optgroup>
                    <optgroup label="gray">
                        <option value="#d1d5db">‚ñ† gray-300</option>
                        <option value="#6b7280">‚ñ† gray-500</option>
                        <option value="#111827">‚ñ† gray-700</option>
                    </optgroup>
                    <optgroup label="red">
                        <option value="#fecdd3">‚ñ† red-300</option>
                        <option value="#ef4444">‚ñ† red-500</option>
                        <option value="#991b1b">‚ñ† red-700</option>
                    </optgroup>
                    <optgroup label="orange">
                        <option value="#fed7aa">‚ñ† orange-300</option>
                        <option value="#f97316">‚ñ† orange-500</option>
                        <option value="#c2410c">‚ñ† orange-700</option>
                    </optgroup>
                    <optgroup label="amber">
                        <option value="#fde68a">‚ñ† amber-300</option>
                        <option value="#f59e0b">‚ñ† amber-500</option>
                        <option value="#92400e">‚ñ† amber-700</option>
                    </optgroup>
                    <optgroup label="yellow">
                        <option value="#fef08a">‚ñ† yellow-300</option>
                        <option value="#eab308">‚ñ† yellow-500</option>
                        <option value="#713f12">‚ñ† yellow-700</option>
                    </optgroup>
                    <optgroup label="lime">
                        <option value="#d9f99d">‚ñ† lime-300</option>
                        <option value="#84cc16">‚ñ† lime-500</option>
                        <option value="#365314">‚ñ† lime-700</option>
                    </optgroup>
                    <optgroup label="green">
                        <option value="#bbf7d0">‚ñ† green-300</option>
                        <option value="#22c55e">‚ñ† green-500</option>
                        <option value="#166534">‚ñ† green-700</option>
                    </optgroup>
                    <optgroup label="emerald">
                        <option value="#6ee7b7">‚ñ† emerald-300</option>
                        <option value="#10b981">‚ñ† emerald-500</option>
                        <option value="#064e3b">‚ñ† emerald-700</option>
                    </optgroup>
                    <optgroup label="teal">
                        <option value="#5eead4">‚ñ† teal-300</option>
                        <option value="#14b8a6">‚ñ† teal-500</option>
                        <option value="#0f766e">‚ñ† teal-700</option>
                    </optgroup>
                    <optgroup label="cyan">
                        <option value="#67e8f9">‚ñ† cyan-300</option>
                        <option value="#06b6d4">‚ñ† cyan-500</option>
                        <option value="#164e63">‚ñ† cyan-700</option>
                    </optgroup>
                    <optgroup label="sky">
                        <option value="#7dd3fc">‚ñ† sky-300</option>
                        <option value="#0ea5e9">‚ñ† sky-500</option>
                        <option value="#075985">‚ñ† sky-700</option>
                    </optgroup>
                    <optgroup label="blue">
                        <option value="#93c5fd">‚ñ† blue-300</option>
                        <option value="#3b82f6">‚ñ† blue-500</option>
                        <option value="#1e40af">‚ñ† blue-700</option>
                    </optgroup>
                    <optgroup label="indigo">
                        <option value="#a5b4fc">‚ñ† indigo-300</option>
                        <option value="#6366f1">‚ñ† indigo-500</option>
                        <option value="#312e81">‚ñ† indigo-700</option>
                    </optgroup>
                    <optgroup label="violet">
                        <option value="#c4b5fd">‚ñ† violet-300</option>
                        <option value="#8b5cf6">‚ñ† violet-500</option>
                        <option value="#5b21b6">‚ñ† violet-700</option>
                    </optgroup>
                    <optgroup label="purple">
                        <option value="#d8b4fe">‚ñ† purple-300</option>
                        <option value="#a855f7">‚ñ† purple-500</option>
                        <option value="#6b21a8">‚ñ† purple-700</option>
                    </optgroup>
                    <optgroup label="fuchsia">
                        <option value="#fbcfe8">‚ñ† fuchsia-300</option>
                        <option value="#d946ef">‚ñ† fuchsia-500</option>
                        <option value="#831843">‚ñ† fuchsia-700</option>
                    </optgroup>
                    <optgroup label="pink">
                        <option value="#f9a8d4">‚ñ† pink-300</option>
                        <option value="#ec4899">‚ñ† pink-500</option>
                        <option value="#9d174d">‚ñ† pink-700</option>
                    </optgroup>
                    <optgroup label="rose">
                        <option value="#fecdd3">‚ñ† rose-300</option>
                        <option value="#f43f5e">‚ñ† rose-500</option>
                        <option value="#881337">‚ñ† rose-700</option>
                    </optgroup>
                </select>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Horizontal Rule -->
                <button data-cmd="insertHorizontalRule" class="btn btn-sm btn-ghost" title="Horizontale Linie"><i
                        class="bx bx-minus"></i></button>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Code‚ÄëFence -->
                <select id="selCodeLang" class="select select-sm" title="Code‚ÄëSprache">
                    <option value="language-javascript" selected>JS</option>
                    <option value="language-css">CSS</option>
                    <option value="language-markup">HTML</option>
                    <option value="language-python">Py</option>
                    <option value="language-java">Java</option>
                    <option value="language-csharp">C#</option>
                    <option value="language-go">Go</option>
                    <option value="language-ruby">Ruby</option>
                    <!-- ‚Ä¶ weitere Prism‚ÄëSprachen ‚Ä¶ -->
                </select>
                <button id="btnCodeFence" class="btn btn-sm btn-ghost" title="Code‚ÄëBlock"><i
                        class="bx bx-code"></i></button>

                <!-- <div class="divider divider-horizontal m-0"></div> -->


            </div>

            <!-- <div class="divider divider-horizontal m-0"></div>

            <div id="info" class="text-sm opacity-70 ml-auto"></div>
            <button id="btnSettings" class="btn btn-ghost btn-sm"><i class='bx bx-cog'></i></button> -->
            <!-- <button id="btnSettings" class="btn btn-ghost btn-sm">‚öôÔ∏è</button> -->
        </nav>

        <!-- Settings Drawer -->
        <input id="settingsToggle" type="checkbox" class="drawer-toggle hidden" />
        <div id="settingsDrawer" class="drawer-side z-50">
            <label for="settingsToggle" class="drawer-overlay"></label>
            <div class="w-80 bg-base-100 p-6 space-y-4 gap-1">
                <h2 class="text-xl font-bold mb-4"><i class='bx bx-cog'></i> Einstellungen</h2>
                <!-- <h2 class="text-xl font-bold mb-4">‚öôÔ∏è¬†Einstellungen</h2> -->
                <div><i class="bx bx-broadcast"></i>
                    <span id="info" class="text-sm opacity-70 ml-auto"></span>
                </div>
                <div class="form-control">
                    <label class="flex cursor-pointer gap-2 items-center">
                        <span class="label-text">Dark Mode</span>
                        <i class='bx bx-sun'></i>
                        <input id="chkDark" type="checkbox" class="toggle theme-controller" />
                        <i class='bx bx-moon'></i>
                    </label>
                </div>
                <div id="autosaveControl" class="form-control w-full">
                    <div class="label"><span class="label-text"><i class='bx bx-save'></i>Autosave (ms)</span></div>
                    <!-- <div class="label"><span class="label-text">üíæ¬†Autosave (ms)</span></div> -->
                    <input id="inpAutosave" type="number" step="500" min="500" class="input input-bordered w-full" />
                </div>
                <button id="btnSaveSettings" class="btn btn-primary w-full mt-4"><i class='bx bxs-save'></i></button>
            </div>
        </div>


        <!-- Editor -->
        <!-- contenteditable="true" -->
        <main id="blockArea" class="flex-1 overflow-auto p-6 space-y-3">

            <!-- Toast-Container -->
            <div id="toast-wrapper" class="toast toast-end">

            </div>

            <!-- Modal -->

            <!-- Open the modal using ID.showModal() method -->
            <button class="btn" onclick="my_modal_2.showModal()">open modal</button>
            <dialog id="my_modal_2" class="modal">
                <div class="modal-box">
                    <h3 class="text-lg font-bold">Hello!</h3>
                    <p class="py-4">Press ESC key or click outside to close</p>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>close</button>
                </form>
            </dialog>


        </main>

    </div>

    <script>
        var infoClicked = false;
        document.getElementById('info').addEventListener('click', function () {
            if (!infoClicked) {
                const el = this;
                const text = el.textContent.trim();
                copyToClipboard(text)
                    .then(() => {
                        const original = el.textContent;
                        el.textContent = '‚úîÔ∏è kopiert';
                        infoClicked = true;
                        setTimeout(() => { el.textContent = original; infoClicked = false }, 1000);
                    })
                    .catch(err => {
                        console.error('Kopieren fehlgeschlagen:', err);
                    });
            } else {
                showToast('Bereits kopiert!');
            }
        });
    </script>

    <script>
        (async () => {
            const socket = io();
            let currentFile = null, blocks = [];
            let isSaving = false;  // Flag to ignore our own save broadcasts

            // STATE f√ºr neue Blocks
            const state = { mode: 'note', bold: false, color: '', size: '3', lang: 'language-javascript' };
            const sizeClass = {
                '1': 'text-xs', '2': 'text-sm', '3': 'text-base',
                '4': 'text-lg', '5': 'text-xl', '6': 'text-2xl'
            };

            // ELEMENT‚ÄëREFERENCES
            const fileList = document.getElementById('fileList');
            const newFileInput = document.getElementById('newFileName');
            const btnAdd = document.getElementById('btnAdd');
            const btnRename = document.getElementById('btnRename');
            const btnDelete = document.getElementById('btnDelete');
            const blockArea = document.getElementById('blockArea');
            const btnNote = document.getElementById('btnNote');
            const btnCheck = document.getElementById('btnCheck');
            // const btnCode = document.getElementById('btnCode');
            const btnAddBlock = document.getElementById('btnAddBlock');

            // TOOLBAR‚ÄëELEMENTS
            const toolbarBtns = document.querySelectorAll('#toolbar [data-cmd]');
            const selHeading = document.getElementById('selHeading');
            const selFontSize = document.getElementById('selFontSize');
            const selForeColor = document.getElementById('selForeColor');
            const selBackColor = document.getElementById('selBackColor');
            const selCodeLang = document.getElementById('selCodeLang');
            const btnCodeFence = document.getElementById('btnCodeFence');
            const btnCheckboxList = document.getElementById('btnCheckboxList');

            // ‚îÄ‚îÄ‚îÄ FILE‚ÄëEXPLORER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            async function refreshFileList() {
                const files = await fetch('/api/files').then(r => r.json());
                fileList.innerHTML = '';
                files.forEach(name => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.textContent = name;
                    a.className = 'block truncate cursor-pointer';
                    if (name === currentFile) a.classList.add('menu-active');
                    a.onclick = () => openFile(name);
                    li.append(a);
                    fileList.append(li);
                });
            }

            function setupFileExplorer() {
                btnAdd.onclick = async () => {
                    const n = newFileInput.value.trim(); if (!n) return;
                    isSaving = true;
                    await fetch(`/api/file/${n}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: '[]'
                    });
                    isSaving = false;
                    newFileInput.value = '';
                    await refreshFileList();
                };
                btnRename.onclick = () => {
                    if (!currentFile) return alert('Keine Datei ausgew√§hlt');
                    const a = fileList.querySelector('a.active');
                    enableInlineRename(a.parentElement, currentFile);
                };
                btnDelete.onclick = async () => {
                    if (!currentFile || !confirm('L√∂schen?')) return;
                    isSaving = true;
                    await fetch(`/api/file/${currentFile}`, { method: 'DELETE' });
                    isSaving = false;
                    currentFile = null; blocks = []; renderBlocks();
                    await refreshFileList();
                };
                socket.on('file-updated', name => {
                    if (name === currentFile && !isSaving) {
                        openFile(name);
                    }
                });
                socket.on('file-deleted', name => {
                    if (name === currentFile) {
                        currentFile = null; blocks = []; renderBlocks();
                    }
                    refreshFileList();
                });
            }

            async function openFile(name) {
                currentFile = name;
                blocks = await fetch(`/api/file/${name}`).then(r => r.ok ? r.json() : []);
                renderBlocks();
                await refreshFileList();
            }

            function enableInlineRename(li, oldName) {
                if (li.querySelector('input')) return;
                const a = li.querySelector('a');
                const input = document.createElement('input');
                input.type = 'text';
                input.value = oldName;
                input.className = 'input input-bordered w-full';
                li.replaceChild(input, a);
                input.select();

                function cleanup() {
                    input.removeEventListener('keydown', onEnter);
                    input.removeEventListener('blur', onBlur);
                }
                function restore(name) {
                    const a2 = document.createElement('a');
                    a2.textContent = name;
                    a2.className = 'block truncate cursor-pointer';
                    if (name === currentFile) a2.classList.add('active');
                    a2.onclick = () => openFile(name);
                    li.replaceChild(a2, input);
                }
                async function onEnter(e) {
                    if (e.key === 'Enter') {
                        cleanup();
                        const newName = input.value.trim() || oldName;
                        if (newName !== oldName) {
                            isSaving = true;
                            await fetch(`/api/file/${oldName}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ _rename: newName })
                            });
                            isSaving = false;
                            if (currentFile === oldName) currentFile = newName;
                        }
                        restore(newName);
                        refreshFileList();
                    }
                    if (e.key === 'Escape') {
                        cleanup();
                        restore(oldName);
                    }
                }
                function onBlur() {
                    setTimeout(() => {
                        if (li.contains(input)) {
                            cleanup();
                            restore(oldName);
                        }
                    }, 0);
                }

                input.addEventListener('keydown', onEnter);
                input.addEventListener('blur', onBlur);
            }

            // ‚îÄ‚îÄ‚îÄ TOOLBAR (execCommand) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            function setupToolbar() {
                toolbarBtns.forEach(btn => {
                    btn.addEventListener('mousedown', e => e.preventDefault());
                    btn.addEventListener('click', () => {
                        document.execCommand(btn.dataset.cmd, false, null);
                        updateToolbarState();
                    });
                });

                selHeading.addEventListener('change', () => document.execCommand('formatBlock', false, selHeading.value));
                selFontSize.addEventListener('change', () => document.execCommand('fontSize', false, selFontSize.value));
                selForeColor.addEventListener('change', () => document.execCommand('foreColor', false, selForeColor.value));
                selBackColor.addEventListener('change', () => {
                    const cmd = document.queryCommandSupported('hiliteColor') ? 'hiliteColor' : 'backColor';
                    document.execCommand(cmd, false, selBackColor.value);
                });

                btnCheckboxList.addEventListener('click', () => {
                    document.execCommand('insertHTML', false,
                        '<ul><li><input type="checkbox">¬†</li></ul><p></p>');
                });

                document.querySelector('[data-cmd="insertHorizontalRule"]')
                    .addEventListener('click', () => document.execCommand('insertHorizontalRule'));

                btnCodeFence.addEventListener('click', () => {
                    const lang = selCodeLang.value;
                    const html = `<pre><code contenteditable="true" class="${lang}">\u200B</code></pre><p></p>`;
                    document.execCommand('insertHTML', false, html);
                    setTimeout(() => {
                        Prism.highlightAll();
                        const codes = Array.from(document.querySelectorAll(`pre code.${lang}`));
                        const codeEl = codes.find(c => c.textContent.includes('\u200B'));
                        if (codeEl) {
                            codeEl.textContent = '';
                            const range = document.createRange();
                            range.selectNodeContents(codeEl);
                            range.collapse(true);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                            codeEl.focus();
                        }
                    }, 0);
                });

                // btnCodeFence.addEventListener('click', () => {
                //     const lang = selCodeLang.value; // z.B. "language-java"
                //     const html = `
                //         <pre tabindex="0" class="${lang}">
                //         <code class="${lang}"></code>
                //         </pre><p></p>
                //     `;
                //     // HTML einf√ºgen
                //     document.execCommand('insertHTML', false, html);

                //     // Kurz warten, dann highlighten und Cursor setzen
                //     setTimeout(() => {
                //         Prism.highlightAll();
                //         const codes = Array.from(document.querySelectorAll(`pre.${lang} > code.${lang}`));
                //         const codeEl = codes.find(c => c.textContent.includes('\u200B'));
                //         if (codeEl) {
                //             codeEl.textContent = '';
                //             const range = document.createRange();
                //             range.selectNodeContents(codeEl);
                //             range.collapse(true);
                //             const sel = window.getSelection();
                //             sel.removeAllRanges();
                //             sel.addRange(range);
                //             codeEl.focus();
                //         }
                //     }, 0);
                // });


                document.addEventListener('selectionchange', updateToolbarState);
                updateToolbarState();
            }

            function updateToolbarState() {
                toolbarBtns.forEach(b => {
                    document.queryCommandState(b.dataset.cmd)
                        ? b.classList.add('btn-active')
                        : b.classList.remove('btn-active');
                });
                selHeading.value = (document.queryCommandValue('formatBlock') || 'p').toLowerCase();
                selFontSize.value = document.queryCommandValue('fontSize') || '3';
            }

            // ‚îÄ‚îÄ‚îÄ BLOCK EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            function setupEditor() {
                btnNote.onclick = () => selectMode('note', btnNote);
                btnCheck.onclick = () => selectMode('check', btnCheck);
                // btnCode.onclick = () => selectMode('code', btnCode);
                btnAddBlock.onclick = addBlock;
                blockArea.addEventListener('dblclick', e => {
                    if (e.target === blockArea) addBlock();
                });
            }

            function selectMode(m, btn) {
                state.mode = m;
                // [btnNote, btnCheck, btnCode, btnAddBlock]
                [btnNote, btnCheck, btnAddBlock]
                    .forEach(b => b.classList.remove('btn-active'));
                btn.classList.add('btn-active');
            }

            function addBlock() {
                let b;
                if (state.mode === 'note') {
                    b = { type: 'note', text: '', style: { bold: state.bold, color: state.color, size: state.size } };
                } else if (state.mode === 'check') {
                    b = { type: 'check', text: '', checked: false };
                } else {
                    b = { type: 'code', code: '', lang: selCodeLang.value };
                }
                blocks.push(b);
                renderBlocks();
                save();
            }

            async function save() {
                if (!currentFile) return;
                isSaving = true;
                await fetch(`/api/file/${currentFile}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(blocks)
                });
                isSaving = false;
            }

            function renderBlocks() {
                blockArea.innerHTML = '';
                blocks.forEach((b, i) => {
                    const wrap = document.createElement('div');
                    wrap.className = 'p-2 bg-base-100 rounded shadow flex gap-2';
                    wrap.draggable = true;
                    wrap.ondragstart = e => e.dataTransfer.setData('text', i);
                    wrap.ondrop = e => { e.preventDefault(); moveBlock(+e.dataTransfer.getData('text'), i); };
                    wrap.ondragover = e => e.preventDefault();

                    if (b.type === 'note') {
                        const d = makeEditable(b.text, v => { b.text = v; debounceSave(); });
                        if (b.style.bold) d.classList.add('font-bold');
                        if (b.style.color) d.style.color = b.style.color;
                        d.classList.add(sizeClass[b.style.size] || 'text-base');
                        wrap.append(d);
                    }
                    else if (b.type === 'check') {
                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.checked = b.checked;
                        cb.onchange = () => { b.checked = cb.checked; save(); };
                        const d = makeEditable(b.text, v => { b.text = v; });
                        if (b.checked) d.classList.add('line-through');
                        wrap.append(cb, d);
                    }
                    else {
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        code.className = b.lang;
                        code.textContent = b.code || '';
                        code.contentEditable = true;
                        code.oninput = () => { b.code = code.textContent; Prism.highlightElement(code); debounceSave(); };
                        pre.append(code);
                        wrap.append(pre);
                        Prism.highlightElement(code);
                    }

                    const del = document.createElement('button');
                    del.className = 'btn btn-ghost btn-xs';
                    del.innerHTML = '<i class="bx bx-trash"></i>';
                    // del.textContent = 'üóëÔ∏è';
                    del.onclick = () => { blocks.splice(i, 1); renderBlocks(); save(); };
                    wrap.append(del);

                    blockArea.append(wrap);
                });

                Prism.highlightAll();
            }

            function makeEditable(html, onChange) {
                const d = document.createElement('div');
                d.contentEditable = true;
                d.className = 'flex-1 outline-none';
                d.innerHTML = html || '';
                d.oninput = () => onChange(d.innerHTML);
                return d;
            }

            function moveBlock(src, tgt) {
                if (src === tgt) return;
                blocks.splice(tgt, 0, blocks.splice(src, 1)[0]);
                renderBlocks();
                save();
            }

            function debounce(fn, ms) {
                let t;
                return (...a) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn(...a), ms);
                };
            }
            const debounceSave = debounce(save, 700);

            // ‚îÄ‚îÄ‚îÄ INITIALIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            await refreshFileList();
            setupFileExplorer();
            setupToolbar();
            setupEditor();
            fetch('/api/info')
                .then(r => r.json())
                .then(d => document.getElementById('info').textContent = `${d.ip}:${d.port}`);

        })();
    </script>


    <!-- <script>
        (async () => {
            const socket = io();
            let currentFile = null, blocks = [];

            // STATE f√ºr neue Blocks
            const state = { mode: 'note', bold: false, color: '', size: '3', lang: 'language-javascript' };
            const sizeClass = {
                '1': 'text-xs',
                '2': 'text-sm',
                '3': 'text-base',
                '4': 'text-lg',
                '5': 'text-xl',
                '6': 'text-2xl'
            };

            // ELEMENT‚ÄëREFERENCES
            const fileList = document.getElementById('fileList');
            const newFileInput = document.getElementById('newFileName');
            const btnAdd = document.getElementById('btnAdd');
            const btnRename = document.getElementById('btnRename');
            const btnDelete = document.getElementById('btnDelete');
            const blockArea = document.getElementById('blockArea');
            const btnNote = document.getElementById('btnNote');
            const btnCheck = document.getElementById('btnCheck');
            const btnCode = document.getElementById('btnCode');
            const btnAddBlock = document.getElementById('btnAddBlock');

            // TOOLBAR‚ÄëELEMENTS
            const toolbarBtns = document.querySelectorAll('#toolbar [data-cmd]');
            const selHeading = document.getElementById('selHeading');
            const selFontSize = document.getElementById('selFontSize');
            const selForeColor = document.getElementById('selForeColor');
            const selBackColor = document.getElementById('selBackColor');
            const selCodeLang = document.getElementById('selCodeLang');
            const btnCodeFence = document.getElementById('btnCodeFence');
            const btnCheckboxList = document.getElementById('btnCheckboxList');

            // ‚îÄ‚îÄ‚îÄ FILE‚ÄëEXPLORER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            async function refreshFileList() {
                const files = await fetch('/api/files').then(r => r.json());
                fileList.innerHTML = '';
                files.forEach(name => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.textContent = name;
                    a.className = 'block truncate cursor-pointer';
                    if (name === currentFile) a.classList.add('active');
                    a.onclick = () => openFile(name);
                    li.append(a);
                    fileList.append(li);
                });
            }

            function setupFileExplorer() {
                btnAdd.onclick = async () => {
                    const n = newFileInput.value.trim(); if (!n) return;
                    await fetch(`/api/file/${n}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '[]' });
                    newFileInput.value = '';
                    await refreshFileList();
                };
                btnRename.onclick = () => {
                    if (!currentFile) return alert('Keine Datei ausgew√§hlt');
                    const a = fileList.querySelector('a.active');
                    enableInlineRename(a.parentElement, currentFile);
                };
                btnDelete.onclick = async () => {
                    if (!currentFile || !confirm('L√∂schen?')) return;
                    await fetch(`/api/file/${currentFile}`, { method: 'DELETE' });
                    currentFile = null; blocks = []; renderBlocks();
                    await refreshFileList();
                };
                socket.on('file-updated', name => { if (name === currentFile) openFile(name); });
                socket.on('file-deleted', name => {
                    if (name === currentFile) { currentFile = null; blocks = []; renderBlocks(); }
                    refreshFileList();
                });
            }

            async function openFile(name) {
                currentFile = name;
                blocks = await fetch(`/api/file/${name}`)
                    .then(r => r.ok ? r.json() : []);
                renderBlocks();
                await refreshFileList();
            }

            function enableInlineRename(li, oldName) {
                if (li.querySelector('input')) return;
                const a = li.querySelector('a');
                const input = document.createElement('input');
                input.type = 'text';
                input.value = oldName;
                input.className = 'input input-bordered w-full';
                li.replaceChild(input, a);
                input.select();

                function cleanup() {
                    input.removeEventListener('keydown', onEnter);
                    input.removeEventListener('blur', onBlur);
                }
                function restore(name) {
                    const a2 = document.createElement('a');
                    a2.textContent = name;
                    a2.className = 'block truncate cursor-pointer';
                    if (name === currentFile) a2.classList.add('active');
                    a2.onclick = () => openFile(name);
                    li.replaceChild(a2, input);
                }
                async function onEnter(e) {
                    if (e.key === 'Enter') {
                        cleanup();
                        const newName = input.value.trim() || oldName;
                        if (newName !== oldName) {
                            await fetch(`/api/file/${oldName}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ _rename: newName })
                            });
                            if (currentFile === oldName) currentFile = newName;
                        }
                        restore(newName);
                        refreshFileList();
                    }
                    if (e.key === 'Escape') {
                        cleanup();
                        restore(oldName);
                    }
                }
                function onBlur() {
                    setTimeout(() => {
                        if (li.contains(input)) {
                            cleanup();
                            restore(oldName);
                        }
                    }, 0);
                }

                input.addEventListener('keydown', onEnter);
                input.addEventListener('blur', onBlur);
            }

            // ‚îÄ‚îÄ‚îÄ TOOLBAR (execCommand) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            function setupToolbar() {
                toolbarBtns.forEach(btn => {
                    // Fokus behalten
                    btn.addEventListener('mousedown', e => e.preventDefault());
                    btn.addEventListener('click', () => {
                        document.execCommand(btn.dataset.cmd, false, null);
                        updateToolbarState();
                    });
                });

                selHeading.addEventListener('change', () => document.execCommand('formatBlock', false, selHeading.value));
                selFontSize.addEventListener('change', () => document.execCommand('fontSize', false, selFontSize.value));
                selForeColor.addEventListener('change', () => document.execCommand('foreColor', false, selForeColor.value));
                selBackColor.addEventListener('change', () => {
                    const cmd = document.queryCommandSupported('hiliteColor') ? 'hiliteColor' : 'backColor';
                    document.execCommand(cmd, false, selBackColor.value);
                });

                btnCheckboxList.addEventListener('click', () => {
                    document.execCommand('insertHTML', false,
                        '<ul><li><input type="checkbox">¬†</li></ul><p></p>');
                });

                document.querySelector('[data-cmd="insertHorizontalRule"]')
                    .addEventListener('click', () => document.execCommand('insertHorizontalRule'));

                btnCodeFence.addEventListener('click', () => {
                    const lang = selCodeLang.value;
                    const html = `<pre><code contenteditable="true" class="${lang}">\u200B</code></pre><p></p>`;
                    document.execCommand('insertHTML', false, html);
                    setTimeout(() => {
                        Prism.highlightAll();
                        const codes = Array.from(document.querySelectorAll(`pre code.${lang}`));
                        const codeEl = codes.find(c => c.textContent.includes('\u200B'));
                        if (codeEl) {
                            codeEl.textContent = '';
                            const range = document.createRange();
                            range.selectNodeContents(codeEl);
                            range.collapse(true);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                            codeEl.focus();
                        }
                    }, 0);
                });

                document.addEventListener('selectionchange', updateToolbarState);
                updateToolbarState();
            }

            function updateToolbarState() {
                toolbarBtns.forEach(b => {
                    document.queryCommandState(b.dataset.cmd)
                        ? b.classList.add('btn-active')
                        : b.classList.remove('btn-active');
                });
                selHeading.value = (document.queryCommandValue('formatBlock') || 'p').toLowerCase();
                selFontSize.value = document.queryCommandValue('fontSize') || '3';
            }

            // ‚îÄ‚îÄ‚îÄ BLOCK EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            function setupEditor() {
                btnNote.onclick = () => selectMode('note', btnNote);
                btnCheck.onclick = () => selectMode('check', btnCheck);
                btnCode.onclick = () => selectMode('code', btnCode);
                btnAddBlock.onclick = addBlock;
                blockArea.addEventListener('dblclick', e => {
                    if (e.target === blockArea) addBlock();
                });
            }

            function selectMode(m, btn) {
                state.mode = m;
                [btnNote, btnCheck, btnCode, btnAddBlock].forEach(b => b.classList.remove('btn-active'));
                btn.classList.add('btn-active');
            }

            function addBlock() {
                let b;
                if (state.mode === 'note') {
                    b = { type: 'note', text: '', style: { bold: state.bold, color: state.color, size: state.size } };
                } else if (state.mode === 'check') {
                    b = { type: 'check', text: '', checked: false };
                } else {
                    b = { type: 'code', code: '', lang: state.lang = selCodeLang.value };
                }
                blocks.push(b);
                renderBlocks();
                save();
            }

            async function save() {
                if (!currentFile) return;
                await fetch(`/api/file/${currentFile}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(blocks)
                });
            }

            function renderBlocks() {
                blockArea.innerHTML = '';
                blocks.forEach((b, i) => {
                    const wrap = document.createElement('div');
                    wrap.className = 'p-2 bg-base-100 rounded shadow flex gap-2';
                    wrap.draggable = true;
                    wrap.ondragstart = e => e.dataTransfer.setData('text', i);
                    wrap.ondrop = e => { e.preventDefault(); moveBlock(+e.dataTransfer.getData('text'), i); };
                    wrap.ondragover = e => e.preventDefault();

                    if (b.type === 'note') {
                        const d = makeEditable(b.text, v => { b.text = v; debounceSave(); });
                        if (b.style.bold) d.classList.add('font-bold');
                        if (b.style.color) d.style.color = b.style.color;
                        d.classList.add(sizeClass[b.style.size] || 'text-base');
                        wrap.append(d);
                    }
                    else if (b.type === 'check') {
                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.checked = b.checked;
                        cb.onchange = () => { b.checked = cb.checked; save(); };
                        const d = makeEditable(b.text, v => { b.text = v; });
                        if (b.checked) d.classList.add('line-through');
                        wrap.append(cb, d);
                    }
                    else {
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        code.className = b.lang;
                        code.textContent = b.code || '';
                        code.contentEditable = true;
                        code.oninput = () => { b.code = code.textContent; Prism.highlightElement(code); debounceSave(); };
                        pre.append(code);
                        wrap.append(pre);
                        Prism.highlightElement(code);
                    }

                    const del = document.createElement('button');
                    del.className = 'btn btn-ghost btn-xs';
                    del.textContent = 'üóëÔ∏è';
                    del.onclick = () => { blocks.splice(i, 1); renderBlocks(); save(); };
                    wrap.append(del);

                    blockArea.append(wrap);
                });

                // Sicherstellen, dass alle Codebl√∂cke formatiert sind
                Prism.highlightAll();
            }

            function makeEditable(html, onChange) {
                const d = document.createElement('div');
                d.contentEditable = true;
                d.className = 'flex-1 outline-none';
                d.innerHTML = html || '';
                d.oninput = () => onChange(d.innerHTML);
                return d;
            }

            function moveBlock(src, tgt) {
                if (src === tgt) return;
                blocks.splice(tgt, 0, blocks.splice(src, 1)[0]);
                renderBlocks();
                save();
            }

            function debounce(fn, ms) {
                let t;
                return (...a) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn(...a), ms);
                };
            }
            const debounceSave = debounce(save, 700);

            // ‚îÄ‚îÄ‚îÄ INITIALIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            await refreshFileList();
            setupFileExplorer();
            setupToolbar();
            setupEditor();
            fetch('/api/info')
                .then(r => r.json())
                .then(d => document.getElementById('info').textContent = `üì° ${d.ip}:${d.port}`);

        })();
    </script> -->




    <!-- <script>
        (async () => {
            const socket = io();
            let currentFile = null, blocks = [];
            const state = { mode: 'note', bold: false, color: '', size: '3', lang: 'javascript' };
            const sizeClass = { '1': 'text-xs', '2': 'text-sm', '3': 'text-base', '4': 'text-lg', '5': 'text-xl', '6': 'text-2xl' };

            // Elemente
            const fileList = document.getElementById('fileList');
            const newFileInput = document.getElementById('newFileName');
            const btnAdd = document.getElementById('btnAdd');
            const btnRename = document.getElementById('btnRename');
            const btnDelete = document.getElementById('btnDelete');
            const blockArea = document.getElementById('blockArea');
            const btnNote = document.getElementById('btnNote');
            const btnCheck = document.getElementById('btnCheck');
            const btnCode = document.getElementById('btnCode');
            const btnAddBlock = document.getElementById('btnAddBlock');

            const toolbarBtns = document.querySelectorAll('#toolbar [data-cmd]');
            const selHeading = document.getElementById('selHeading');
            const selFontSize = document.getElementById('selFontSize');
            const selForeColor = document.getElementById('selForeColor');
            const selBackColor = document.getElementById('selBackColor');
            const selCodeLang = document.getElementById('selCodeLang');
            const btnCodeFence = document.getElementById('btnCodeFence');
            const btnCheckboxList = document.getElementById('btnCheckboxList');

            // ‚îÄ‚îÄ‚îÄ FILE‚ÄëEXPLORER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            async function refreshFileList() {
                const files = await fetch('/api/files').then(r => r.json());
                fileList.innerHTML = '';
                files.forEach(name => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.textContent = name;
                    a.className = 'block truncate cursor-pointer';
                    if (name === currentFile) a.classList.add('active');
                    a.onclick = () => openFile(name);
                    li.append(a);
                    fileList.append(li);
                });
            }

            function setupFileExplorer() {
                btnAdd.onclick = async () => {
                    const n = newFileInput.value.trim(); if (!n) return;
                    await fetch(`/api/file/${n}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '[]' });
                    newFileInput.value = ''; await refreshFileList();
                };
                btnRename.onclick = () => {
                    if (!currentFile) return alert('Keine Datei ausgew√§hlt');
                    const a = fileList.querySelector('a.active');
                    enableInlineRename(a.parentElement, currentFile);
                };
                btnDelete.onclick = async () => {
                    if (!currentFile || !confirm('L√∂schen?')) return;
                    await fetch(`/api/file/${currentFile}`, { method: 'DELETE' });
                    currentFile = null; blocks = []; renderBlocks(); await refreshFileList();
                };
                socket.on('file-updated', name => { if (name === currentFile) openFile(name); });
                socket.on('file-deleted', name => {
                    if (name === currentFile) { currentFile = null; blocks = []; renderBlocks(); }
                    refreshFileList();
                });
            }

            async function openFile(name) {
                currentFile = name;
                blocks = await fetch(`/api/file/${name}`).then(r => r.ok ? r.json() : []);
                renderBlocks();
                await refreshFileList();
            }

            function enableInlineRename(li, oldName) {
                if (li.querySelector('input')) return;
                const a = li.querySelector('a');
                const input = document.createElement('input');
                input.type = 'text';
                input.value = oldName;
                input.className = 'input input-bordered w-full';
                li.replaceChild(input, a);
                input.select();

                function cleanup() {
                    input.removeEventListener('keydown', onEnter);
                    input.removeEventListener('blur', onBlur);
                }
                function restore(name) {
                    const a2 = document.createElement('a');
                    a2.textContent = name;
                    a2.className = 'block truncate cursor-pointer';
                    if (name === currentFile) a2.classList.add('active');
                    a2.onclick = () => openFile(name);
                    li.replaceChild(a2, input);
                }
                async function onEnter(e) {
                    if (e.key === 'Enter') {
                        cleanup();
                        const newName = input.value.trim() || oldName;
                        if (newName !== oldName) {
                            await fetch(`/api/file/${oldName}`, {
                                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ _rename: newName })
                            });
                            if (currentFile === oldName) currentFile = newName;
                        }
                        restore(newName);
                        refreshFileList();
                    }
                    if (e.key === 'Escape') {
                        cleanup();
                        restore(oldName);
                    }
                }
                function onBlur() {
                    setTimeout(() => {
                        if (li.contains(input)) {
                            cleanup();
                            restore(oldName);
                        }
                    }, 0);
                }
                input.addEventListener('keydown', onEnter);
                input.addEventListener('blur', onBlur);
            }

            // ‚îÄ‚îÄ‚îÄ TOOLBAR (execCommand) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            function setupToolbar() {
                toolbarBtns.forEach(btn => {
                    // Verhindert, dass Button-Klick den Editor-Fokus klaut
                    btn.addEventListener('mousedown', e => e.preventDefault());
                    btn.addEventListener('click', () => {
                        document.execCommand(btn.dataset.cmd, false, null);
                        updateToolbarState();
                    });
                });

                selHeading.addEventListener('change', () => document.execCommand('formatBlock', false, selHeading.value));
                selFontSize.addEventListener('change', () => document.execCommand('fontSize', false, selFontSize.value));
                selForeColor.addEventListener('change', () => document.execCommand('foreColor', false, selForeColor.value));
                selBackColor.addEventListener('change', () => {
                    const cmd = document.queryCommandSupported('hiliteColor') ? 'hiliteColor' : 'backColor';
                    document.execCommand(cmd, false, selBackColor.value);
                });

                btnCheckboxList.addEventListener('click', () => {
                    document.execCommand('insertHTML', false,
                        '<ul><li><input type="checkbox">¬†</li></ul><p></p>');
                });

                document.querySelector('[data-cmd="insertHorizontalRule"]')
                    .addEventListener('click', () => document.execCommand('insertHorizontalRule'));

                btnCodeFence.addEventListener('click', () => {
                    const lang = selCodeLang.value;
                    // Erzeuge HTML mit contenteditable + zero‚Äëwidth space
                    const html = `<pre><code contenteditable="true" class="${lang}">\u200B</code></pre><p></p>`;
                    // Mit execCommand einf√ºgen
                    document.execCommand('insertHTML', false, html);

                    // kurz warten, bis das DOM aktualisiert ist
                    setTimeout(() => {
                        // Highlight neu anwenden
                        Prism.highlightAll();
                        // Cursor in das neue <code> setzen
                        // Wir suchen das erste code-Element mit unserer Klasse, das noch ein ZWS enth√§lt
                        const codes = Array.from(document.querySelectorAll('pre code.' + lang));
                        const codeEl = codes.find(c => c.textContent.includes('\u200B'));
                        if (codeEl) {
                            // ZWS entfernen
                            codeEl.textContent = '';
                            // Range anlegen
                            const range = document.createRange();
                            range.selectNodeContents(codeEl);
                            range.collapse(true);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                            codeEl.focus();
                        }
                    }, 0);
                });

                document.addEventListener('selectionchange', updateToolbarState);
                updateToolbarState();
            }

            function updateToolbarState() {
                toolbarBtns.forEach(b => {
                    document.queryCommandState(b.dataset.cmd)
                        ? b.classList.add('btn-active')
                        : b.classList.remove('btn-active');
                });
                selHeading.value = (document.queryCommandValue('formatBlock') || 'p').toLowerCase();
                selFontSize.value = document.queryCommandValue('fontSize') || '3';
            }

            // ‚îÄ‚îÄ‚îÄ BLOCK EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            function setupEditor() {
                btnNote.onclick = () => selectMode('note', btnNote);
                btnCheck.onclick = () => selectMode('check', btnCheck);
                btnCode.onclick = () => selectMode('code', btnCode);
                btnAddBlock.onclick = addBlock;

                // Doppelklick auf leere Fl√§che ‚ûù neuer Block
                blockArea.addEventListener('dblclick', e => {
                    if (e.target === blockArea) addBlock();
                });
            }

            function selectMode(m, btn) {
                state.mode = m;
                [btnNote, btnCheck, btnCode, btnAddBlock]
                    .forEach(b => b.classList.remove('btn-active'));
                btn.classList.add('btn-active');
            }

            function addBlock() {
                let b;
                if (state.mode === 'note') b = {
                    type: 'note', text: '', style: {
                        bold: state.bold,
                        color: state.color,
                        size: state.size
                    }
                };
                if (state.mode === 'check') b = { type: 'check', text: '', checked: false };
                if (state.mode === 'code') b = { type: 'code', code: '', lang: state.lang };
                blocks.push(b);
                renderBlocks();
                save();
            }

            async function save() {
                if (!currentFile) return;
                await fetch(`/api/file/${currentFile}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(blocks)
                });
            }

            function renderBlocks() {
                blockArea.innerHTML = '';
                blocks.forEach((b, i) => {
                    const wrap = document.createElement('div');
                    wrap.className = 'p-2 bg-base-100 rounded shadow flex gap-2';
                    wrap.draggable = true;
                    wrap.ondragstart = e => e.dataTransfer.setData('text', i);
                    wrap.ondrop = e => { e.preventDefault(); moveBlock(+e.dataTransfer.getData('text'), i); };
                    wrap.ondragover = e => e.preventDefault();

                    if (b.type === 'note') {
                        const d = makeEditable(b.text, v => { b.text = v; debounceSave(); });
                        if (b.style.bold) d.classList.add('font-bold');
                        if (b.style.color) d.style.color = b.style.color;
                        d.classList.add(sizeClass[b.style.size] || 'text-base');
                        wrap.append(d);
                    }
                    else if (b.type === 'check') {
                        const cb = document.createElement('input');
                        cb.type = 'checkbox'; cb.checked = b.checked;
                        cb.onchange = () => { b.checked = cb.checked; save(); };
                        const d = makeEditable(b.text, v => { b.text = v; });
                        if (cb.checked) d.classList.add('line-through');
                        wrap.append(cb, d);
                    }
                    else {
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        code.className = `language-${b.lang}`;
                        code.textContent = b.code || '';
                        code.contentEditable = true;
                        code.oninput = () => { b.code = code.textContent; Prism.highlightElement(code); debounceSave(); };
                        pre.append(code); wrap.append(pre);
                        Prism.highlightElement(code);
                    }

                    const del = document.createElement('button');
                    del.className = 'btn btn-ghost btn-xs'; del.textContent = 'üóëÔ∏è';
                    del.onclick = () => { blocks.splice(i, 1); renderBlocks(); save(); };
                    wrap.append(del);

                    blockArea.append(wrap);
                });

                // nach Rendern nochmal alle Codebl√∂cke highlighten
                Prism.highlightAll();
            }

            function makeEditable(html, onChange) {
                const d = document.createElement('div');
                d.contentEditable = true;
                d.className = 'flex-1 outline-none';
                d.innerHTML = html || '';
                d.oninput = () => onChange(d.innerHTML);
                return d;
            }

            function moveBlock(src, tgt) {
                if (src === tgt) return;
                blocks.splice(tgt, 0, blocks.splice(src, 1)[0]);
                renderBlocks(); save();
            }

            function debounce(fn, ms) {
                let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms) };
            }
              const debounceSave = debounce(save,700);

            // ‚îÄ‚îÄ‚îÄ INITIALIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            await refreshFileList();
            setupFileExplorer();
            setupToolbar();
            setupEditor();
            fetch('/api/info')
                .then(r => r.json())
                .then(d => document.getElementById('info').textContent = `üì° ${d.ip}:${d.port}`);
        })();
    </script> -->


    <script type="module" src="./js/settings.js"></script>
    <script src="./app/app.js"></script>


</body>

</html>