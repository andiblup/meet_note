<!--  index.html  –  Meet_Note One‑Page Editor  -->
<!DOCTYPE html>
<html lang="de" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Meet Note – Editor</title>

    <!-- Tailwind + DaisyUI -->
    <!-- <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.0/dist/full.css" rel="stylesheet"/> -->

    <!-- Prism -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script> -->

    <link rel="stylesheet" href="/styles/output.css">
    <link rel="stylesheet" href="/vendors/prism.css">
    <script src="/vendors/prism.min.js"></script>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>



    <style>
        /* kleine Extras */
        .btn-active {
            background: #3b82f6 !important;
            color: white !important
        }

        code[contenteditable] {
            outline: none;
            min-height: 1.5rem;
            display: block
        }
    </style>

    <!-- <script>
    window.addEventListener('DOMContentLoaded', () => {
      const { theme } = window.electronAPI.getSettings();
      document.documentElement.setAttribute('data-theme', theme);
    });
  </script> -->
</head>

<body class="bg-base-200 min-h-screen flex">

    <!-- === Sidebar (ein-/ausklappbar) ============================= -->
    <input type="checkbox" id="sideToggle" class="drawer-toggle hidden">
    <aside class="drawer-side">
        <label for="sideToggle" class="drawer-overlay"></label>
        <div class="w-72 bg-base-100 p-4 space-y-4 flex flex-col">
            <h2 class="text-lg font-bold">📂 Dateien</h2>

            <ul id="fileList" class="menu bg-base-200 rounded-box flex-1 overflow-auto"></ul>

            <div class="space-y-2">
                <input id="newFileName" class="input input-bordered w-full" placeholder="Neuer Dateiname">
                <div class="flex gap-2">
                    <button id="btnAdd" class="btn btn-primary btn-sm flex-1">➕</button>
                    <button id="btnRename" class="btn btn-outline btn-sm">✏️</button>
                    <button id="btnDelete" class="btn btn-error   btn-sm">🗑️</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- === Content =============================================== -->
    <div class="flex-1 flex flex-col">

        <!-- Header / Toolbar -->
        <nav class="navbar bg-base-100 px-4 shadow">
            <label for="sideToggle" class="btn btn-square btn-ghost">📁</label>

            <div class="flex gap-2">

                <!-- Block‑Typ -->
                <button id="btnNote" class="btn btn-sm btn-ghost">📝</button>
                <button id="btnCheck" class="btn btn-sm btn-ghost">☑️</button>
                <button id="btnCode" class="btn btn-sm btn-ghost">💻</button>
                <button id="btnAddBlock" class="btn btn-sm btn-ghost">➕</button>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Format -->
                <button id="btnBold" class="btn btn-sm btn-ghost font-bold">B</button>
                <select id="selColor" class="select select-sm">
                    <option value="">Farbe</option>
                    <option>red</option>
                    <option>blue</option>
                    <option>green</option>
                </select>
                <select id="selSize" class="select select-sm">
                    <option value="1">XS</option>
                    <option selected value="3">M</option>
                    <option value="5">L</option>
                    <option value="7">XL</option>
                </select>
                <select id="selLang" class="select select-sm">
                    <option value="javascript" selected>JS</option>
                    <option value="python">Py</option>
                    <option value="java">Java</option>
                    <option value="csharp">C#</option>
                </select>
            </div>

            <div id="info" class="text-sm opacity-70"></div>


            <!-- <button id="btnSettings" class="btn btn-ghost btn-sm ml-auto">⚙️</button> -->
            <button id="btnSettings" class="btn btn-ghost btn-sm ml-auto">⚙️</button>
        </nav>

        <!-- Settings Drawer -->
        <!-- <input id="settingsToggle" type="checkbox" class="drawer-toggle hidden" />
        <div class="drawer-side">
            <label for="settingsToggle" class="drawer-overlay"></label>

            <div class="w-80 bg-base-100 p-6 space-y-4">
                <h2 class="text-xl font-bold mb-4">⚙️ Einstellungen</h2>

                <div class="form-control">
                    <label class="flex cursor-pointer gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5" />
                            <path
                                d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" />
                        </svg>
                        <input id="chkDark" type="checkbox" value="dark" class="toggle theme-controller" />
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </label>
                </div>

                <label class="form-control w-full">
                    <div class="label"><span class="label-text">💾 Autosave (ms)</span></div>
                    <input id="inpAutosave" type="number" step="500" min="500" value="10000"
                        class="input input-bordered w-full" />
                </label>

                <button id="btnSaveSettings" class="btn btn-primary w-full mt-4">Speichern</button>
            </div>
        </div> -->
        <div id="electronSettings" class="hidden">
            <input id="settingsToggle" type="checkbox" class="drawer-toggle hidden" />
            <div class="drawer-side">
                <label for="settingsToggle" class="drawer-overlay"></label>
                <div class="w-80 bg-base-100 p-6 space-y-4">
                    <h2 class="text-xl font-bold mb-4">⚙️ Einstellungen (App‑weit)</h2>
                    <div class="form-control">
                        <label class="flex cursor-pointer gap-2 items-center">
                            <span class="label-text">Dark Mode</span>
                            <input id="chkDark" type="checkbox" class="toggle theme-controller" />
                        </label>
                    </div>
                    <label class="form-control w-full">
                        <div class="label"><span class="label-text">💾 Autosave (ms)</span></div>
                        <input id="inpAutosave" type="number" step="500" min="500"
                            class="input input-bordered w-full" />
                    </label>
                    <button id="btnSaveSettings" class="btn btn-primary w-full mt-4">Speichern</button>
                </div>
            </div>
        </div>

        <!-- Block‑Area -->
        <main id="blockArea" class="flex-1 overflow-auto p-6 space-y-3" ondragover="event.preventDefault()"></main>
    </div>

    <!-- ====================== SCRIPT ================================= -->
    <script type="module">
        const socket = io();
        let currentFile = null, blocks = [];
        const list = document.getElementById('fileList');
        const area = document.getElementById('blockArea');

        /* ===== File Explorer ===== */
        async function refreshList() {
            const files = await fetch('/api/files').then(r => r.json());
            list.innerHTML = '';
            files.forEach(f => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="block truncate">${f}</a>`;
                li.onclick = () => openFile(f);
                li.firstChild.classList.toggle('active', f === currentFile);
                list.appendChild(li);
            });
        }
        async function openFile(id) {
            currentFile = id;
            blocks = await fetch('/api/file/' + id).then(r => r.json()).catch(() => []);
            render(); refreshList();
        }
        async function addFile() {
            const n = document.getElementById('newFileName').value.trim();
            if (!n) return;
            await fetch('/api/file', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: n }) });
            document.getElementById('newFileName').value = '';
        }
        async function renameFile() {
            if (!currentFile) return;
            const newId = prompt('Neuer Name:', currentFile); if (!newId || newId === currentFile) return;
            await fetch('/api/file/' + currentFile + '/rename', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ newId }) });
        }
        async function deleteFile() {
            if (!currentFile || !confirm('Löschen?')) return;
            await fetch('/api/file/' + currentFile, { method: 'DELETE' });
            currentFile = null; blocks = []; render();
        }
        document.getElementById('btnAdd').onclick = addFile;
        document.getElementById('btnRename').onclick = renameFile;
        document.getElementById('btnDelete').onclick = deleteFile;

        /* ===== Block‑Toolbar State ===== */
        const state = { mode: 'note', bold: false, color: '', size: '3', lang: 'javascript' };
        function setActive(btn, id) { document.querySelectorAll('#' + id + ' button').forEach(b => b.classList.toggle('btn-active', b === btn)); }
        document.getElementById('btnNote').onclick = e => { state.mode = 'note'; setActive(e.target.parentNode, 'toolbar') };
        document.getElementById('btnCheck').onclick = e => { state.mode = 'check'; setActive(e.target.parentNode, 'toolbar') };
        document.getElementById('btnCode').onclick = e => { state.mode = 'code'; setActive(e.target.parentNode, 'toolbar') };

        document.getElementById('btnBold').onclick = () => state.bold = !state.bold;
        document.getElementById('selColor').onchange = e => state.color = e.target.value;
        document.getElementById('selSize').onchange = e => state.size = e.target.value;
        document.getElementById('selLang').onchange = e => state.lang = e.target.value;

        document.getElementById('btnAddBlock').onclick = addBlock;

        /* ===== Blocks rendering & logic ===== */
        function render() {
            area.innerHTML = '';
            blocks.forEach((b, i) => {
                const wrap = document.createElement('div');
                wrap.className = 'p-2 bg-base-100 rounded shadow flex gap-2';
                wrap.draggable = true;
                wrap.ondragstart = e => e.dataTransfer.setData('text', i);
                wrap.ondrop = e => { e.preventDefault(); const src = +e.dataTransfer.getData('text'); moveBlock(src, i); };
                wrap.ondragover = e => e.preventDefault();

                // content
                if (b.type === 'note') {
                    const div = makeEditable(b.text, b);
                    wrap.appendChild(div);
                }
                if (b.type === 'check') {
                    const cb = document.createElement('input');
                    cb.type = 'checkbox'; cb.checked = b.checked || false;
                    cb.onchange = () => { b.checked = cb.checked; styleCheck(div, cb.checked); save(); };
                    const div = makeEditable(b.text, b);
                    styleCheck(div, cb.checked);
                    wrap.append(cb, div);
                }
                if (b.type === 'code') {
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.className = 'language-' + (b.lang || 'javascript');
                    code.contentEditable = true;
                    code.innerText = b.code || '';
                    code.oninput = _ => { b.code = code.innerText; Prism.highlightElement(code); saveDeb(); };
                    pre.appendChild(code); wrap.appendChild(pre);
                    Prism.highlightElement(code);
                }
                // delete btn
                const del = document.createElement('button');
                del.className = 'btn btn-ghost btn-xs'; del.textContent = '🗑️';
                del.onclick = _ => { blocks.splice(i, 1); render(); save(); };
                wrap.appendChild(del);
                area.appendChild(wrap);
            });
        }
        function makeEditable(html, b) {
            const div = document.createElement('div');
            div.contentEditable = true;
            div.className = 'flex-1 outline-none';
            div.innerHTML = html || '';
            div.oninput = _ => { b.text = div.innerHTML; saveDeb(); };
            return div;
        }
        function styleCheck(el, checked) { el.classList.toggle('line-through', checked); }

        /* drag reorder */
        function moveBlock(src, tgt) {
            if (src === tgt) return;
            blocks.splice(tgt, 0, blocks.splice(src, 1)[0]);
            render(); save();
        }

        /* create new block with current style */
        function addBlock() {
            let block;
            if (state.mode === 'note') {
                block = { type: 'note', text: '', style: { bold: state.bold, color: state.color, size: state.size } };
            }
            else if (state.mode === 'check') {
                block = { type: 'check', text: '', checked: false };
            }
            else {
                block = { type: 'code', code: '', lang: state.lang };
            }
            blocks.push(block); render(); save();
        }

        /* ===== Persist ================================================= */
        async function save() {
            if (!currentFile) return;
            await fetch('/api/file/' + currentFile, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(blocks) });
        }
        const saveDeb = debounce(save, 700);
        function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); } }

        /* ===== Live updates via Socket ================================= */
        socket.on('file-list-changed', refreshList);
        socket.on('file-updated', id => { if (id === currentFile) openFile(id); });

        /* ===== Info ==================================================== */
        fetch('/api/info').then(r => r.json()).then(d => {
            document.getElementById('info').textContent = `📡 ${d.ip}:${d.port}`;
        });

        /* ===== Init ==================================================== */
        refreshList();

        /* prevent dblclick from adding while editing */
        area.addEventListener('dblclick', e => {
            if (e.target === area) addBlock();
        });
    </script>


    <!-- <script type="module">
        /* ==================================================================== */
        /*  SETTINGS  – Drawer / Persistenz / Live‑Sync                         */
        /* ==================================================================== */

        // const settings = { theme: 'light', autosave: 1000 };   // Default
        const settings = {};   // Default

        /* ---- API Helpers --------------------------------------------------- */
        async function loadSettings() {
            Object.assign(settings, await fetch('/api/settings').then(r => r.json()));
            applyTheme(settings.theme);
            document.getElementById('chkDark').checked = settings.theme === 'dark';
            document.getElementById('inpAutosave').value = settings.autosave;
        }

        async function saveSettings() {
            // settings.theme = document.getElementById('chkDark').checked ? 'dark' : 'light';
            settings.autosave = document.getElementById('inpAutosave').value || 1000;
            await fetch('/api/settings', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
        }

        document.getElementById('chkDark').addEventListener('change', e => {
            const liveTheme = e.target.checked ? 'dark' : 'light';
            applyTheme(liveTheme);          // <<— UI wechselt unmittelbar
        });

        /* ---- Theme Anwenden ----------------------------------------------- */
        function applyTheme(t) {
            document.documentElement.setAttribute('data-theme', t);
            settings.theme = t;
            document.getElementById('chkDark').checked = t === 'dark'
            saveSettings();
            // Wenn global gehandelt werden soll
            // socket.emit('settings-updated', { theme: t });
        }

        /* ---- Drawer UI ----------------------------------------------------- */
        document.getElementById('btnSettings').onclick =
            () => document.getElementById('settingsToggle').checked = true;

        document.getElementById('btnSaveSettings').onclick = async () => {
            await saveSettings();
            document.getElementById('settingsToggle').checked = false;
        };

        /* ---- Socket Live‑Push --------------------------------------------- */
        // socket.on('settings-updated', s => {
        //     Object.assign(settings, s);
        //     applyTheme(settings.theme);
        //     document.getElementById('chkDark').checked = settings.theme === 'dark';
        // });

        /* ---- Initial Call -------------------------------------------------- */
        await loadSettings();

    </script> -->
    <script type="module">
        // In launcher.js (analog auch in editor.js)
        window.addEventListener('DOMContentLoaded', async () => {
            const isElectron = !!window.electronAPI;

            // 1) Settings‑UI nur in Electron aktivieren
            if (isElectron) {
                document.getElementById('electronSettings').classList.remove('hidden');
                document.getElementById('btnSettings').classList.remove('hidden');
            } else {
                // Browser‑Fallback: Theme aus localStorage oder prefers-color-scheme
                const saved = localStorage.getItem('theme');
                const theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                document.documentElement.setAttribute('data-theme', theme);

                // Einfacher Toggle im Browser
                document.getElementById('chkDark').checked = theme === 'dark';
                document.getElementById('chkDark').addEventListener('change', () => {
                    const t = document.getElementById('chkDark').checked ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', t);
                    localStorage.setItem('theme', t);
                });

                // Verstecke Autosave‑Steuerung im Browser
                document.getElementById('inpAutosave').parentElement.classList.add('hidden');
                document.getElementById('btnSaveSettings').classList.add('hidden');
            }

            // 2) Wenn Electron, lade & speichere via IPC
            if (isElectron) {
                const settings = await window.electronAPI.getSettings();
                document.documentElement.setAttribute('data-theme', settings.theme);
                document.getElementById('chkDark').checked = settings.theme === 'dark';
                document.getElementById('inpAutosave').value = settings.autosave;

                document.getElementById('btnSettings').addEventListener('click', () => {
                    document.getElementById('settingsToggle').checked = true;
                });
                document.getElementById('chkDark').addEventListener('change', () => {
                    document.documentElement.setAttribute(
                        'data-theme',
                        document.getElementById('chkDark').checked ? 'dark' : 'light'
                    );
                });
                document.getElementById('btnSaveSettings').addEventListener('click', async () => {
                    const newSettings = {
                        theme: document.getElementById('chkDark').checked ? 'dark' : 'light',
                        autosave: Number(document.getElementById('inpAutosave').value) || 5000
                    };
                    await window.electronAPI.saveSettings(newSettings);
                    document.getElementById('settingsToggle').checked = false;
                });
            } else {
                // 3) Wenn Browser, lade & speichere via localStorage
                const saved = localStorage.getItem('theme');
                const theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                document.documentElement.setAttribute('data-theme', theme);
                document.getElementById('chkDark').checked = theme === 'dark';
                document.getElementById('chkDark').addEventListener('change', () => {
                    const t = document.getElementById('chkDark').checked ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', t);
                    localStorage.setItem('theme', t);
                });
            }

        });

    </script>
</body>

</html>