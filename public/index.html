<!--  index.html  â€“  Meet_Note Oneâ€‘Page Editor  -->
<!DOCTYPE html>
<html lang="de" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MeetÂ Note â€“Â Editor</title>

    <!-- TailwindÂ +Â DaisyUI -->
    <!-- <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.0/dist/full.css" rel="stylesheet"/> -->

    <!-- Prism -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script> -->

    <link rel="stylesheet" href="/styles/output.css">
    <link rel="stylesheet" href="/vendors/prism.css">
    <script src="/vendors/prism.min.js"></script>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

</head>

<body class="bg-base-200 min-h-screen flex">

    <input id="sideToggle" type="checkbox" class="drawer-toggle hidden" />

    <aside class="drawer-side">
        <label for="sideToggle" class="drawer-overlay"></label>
        <div class="w-72 bg-base-100 p-4 flex flex-col space-y-4">
            <h2 class="text-lg font-bold">ğŸ“‚ Dateien</h2>

            <!-- File list -->
            <ul id="fileList" class="menu bg-base-200 rounded-box flex-1 overflow-auto"></ul>

            <!-- CRUD controls -->
            <div class="space-y-2">
                <input id="newFileName" class="input input-bordered w-full" placeholder="Neuer Dateinameâ€¦">
                <!-- <div class="flex gap-2">
                    <button id="btnAdd" class="btn btn-primary btn-sm flex-1">â•</button>
                    <button id="btnRename" class="btn btn-outline btn-sm">âœï¸</button>
                    <button id="btnDelete" class="btn btn-error btn-sm">ğŸ—‘ï¸</button>
                </div> -->
                <div class="flex gap-2">
                    <button id="btnAdd" class="btn btn-primary btn-sm flex-1">â•</button>
                    <button id="btnRename" class="btn btn-outline btn-sm">âœï¸</button>
                    <button id="btnDelete" class="btn btn-error   btn-sm">ğŸ—‘ï¸</button>
                </div>

            </div>
        </div>
    </aside>



    <!-- === Content =============================================== -->
    <div class="flex-1 flex flex-col">

        <!-- Header / Toolbar -->
        <nav class="navbar bg-base-100 px-4 shadow">
            <label for="sideToggle" class="btn btn-square btn-ghost">ğŸ“</label>

            <div class="flex gap-2">

                <!-- Blockâ€‘Typ -->
                <button id="btnNote" class="btn btn-sm btn-ghost">ğŸ“</button>
                <button id="btnCheck" class="btn btn-sm btn-ghost">â˜‘ï¸</button>
                <button id="btnCode" class="btn btn-sm btn-ghost">ğŸ’»</button>
                <button id="btnAddBlock" class="btn btn-sm btn-ghost">â•</button>

                <div class="divider divider-horizontal m-0"></div>

                <!-- Format -->
                <button id="btnBold" class="btn btn-sm btn-ghost font-bold">B</button>
                <select id="selColor" class="select select-sm">
                    <option value="">Farbe</option>
                    <option>red</option>
                    <option>blue</option>
                    <option>green</option>
                </select>
                <select id="selSize" class="select select-sm">
                    <option value="1">XS</option>
                    <option selected value="3">M</option>
                    <option value="5">L</option>
                    <option value="7">XL</option>
                </select>
                <select id="selLang" class="select select-sm">
                    <option value="javascript" selected>JS</option>
                    <option value="python">Py</option>
                    <option value="java">Java</option>
                    <option value="csharp">C#</option>
                </select>
            </div>

            <div id="info" class="text-sm opacity-70"></div>


            <!-- <button id="btnSettings" class="btn btn-ghost btn-sm ml-auto">âš™ï¸</button> -->
            <button id="btnSettings" class="btn btn-ghost btn-sm ml-auto">âš™ï¸</button>
        </nav>

        <input id="settingsToggle" type="checkbox" class="drawer-toggle hidden" />
        <div id="settingsDrawer" class="drawer-side">
            <label for="settingsToggle" class="drawer-overlay"></label>
            <div class="w-80 bg-base-100 p-6 space-y-4">
                <h2 class="text-xl font-bold mb-4">âš™ï¸Â Einstellungen</h2>
                <!-- Theme Toggle -->
                <div class="form-control">
                    <label class="flex cursor-pointer gap-2 items-center">
                        <span class="label-text">Dark Mode</span>
                        <input id="chkDark" type="checkbox" class="toggle theme-controller" />
                    </label>
                </div>
                <!-- Autosave nur in Electron -->
                <div id="autosaveControl" class="form-control w-full">
                    <div class="label"><span class="label-text">ğŸ’¾Â Autosave (ms)</span></div>
                    <input id="inpAutosave" type="number" step="500" min="500" class="input input-bordered w-full" />
                </div>
                <button id="btnSaveSettings" class="btn btn-primary w-full mt-4">Speichern</button>
            </div>
        </div>

        <!-- Blockâ€‘Area -->
        <main id="blockArea" class="flex-1 overflow-auto p-6 space-y-3" ondragover="event.preventDefault()"></main>
    </div>

    <!-- ====================== SCRIPT ================================= -->

    <script type="module">
        const socket = window.io(); // globales io()
        let currentFile = null;
        let blocks = [];

        // Elemente
        const fileList = document.getElementById('fileList');
        const newFileInput = document.getElementById('newFileName');
        const btnAdd = document.getElementById('btnAdd');
        const btnDelete = document.getElementById('btnDelete');
        const infoDisplay = document.getElementById('info');
        const blockArea = document.getElementById('blockArea');

        // Toolbar-Buttons
        const btnNote = document.getElementById('btnNote');
        const btnCheck = document.getElementById('btnCheck');
        const btnCode = document.getElementById('btnCode');
        const btnAddBlock = document.getElementById('btnAddBlock');
        const btnBold = document.getElementById('btnBold');
        const selColor = document.getElementById('selColor');
        const selSize = document.getElementById('selSize');
        const selLang = document.getElementById('selLang');
        const toolbarBtns = [btnNote, btnCheck, btnCode, btnAddBlock, btnBold];

        // Toolbar-State
        const state = {
            mode: 'note',
            bold: false,
            color: '',
            size: '3',
            lang: 'javascript'
        };

        // Initialisierung
        document.addEventListener('DOMContentLoaded', async () => {
            await refreshFileList();
            setupToolbar();
            setupEditor();
            setupRenameButton()
            // Serverâ€‘Info
            fetch('/api/info').then(r => r.json()).then(d => {
                infoDisplay.textContent = `ğŸ“¡ ${d.ip}:${d.port}`;
            });
        });

        async function refreshFileList() {
            const files = await fetch('/api/files').then(r => r.json());
            fileList.innerHTML = '';
            for (const name of files) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.textContent = name;
                a.className = 'block truncate cursor-pointer';
                if (name === currentFile) a.classList.add('active');
                a.onclick = () => openFile(name);
                li.append(a);
                fileList.append(li);
            }
        }

        // Button-Handler fÃ¼r Rename
        function setupRenameButton() {
            btnRename.onclick = () => {
                if (!currentFile) {
                    alert('Kein File ausgewÃ¤hlt!');
                    return;
                }
                // finde das <li> mit der aktiven Datei
                const activeA = fileList.querySelector('a.active');
                if (!activeA) return;
                const li = activeA.parentElement;
                enableInlineRename(li, currentFile);
            };
        }

        async function openFile(name) {
            currentFile = name;
            blocks = await fetch(`/api/file/${name}`)
                .then(r => r.ok ? r.json() : [])
                .catch(() => []);
            renderBlocks();
            await refreshFileList();
        }

        btnAdd.onclick = async () => {
            const name = newFileInput.value.trim();
            if (!name) return;
            await fetch(`/api/file/${name}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: '[]'
            });
            newFileInput.value = '';
            await refreshFileList();
        };

        btnDelete.onclick = async () => {
            if (!currentFile || !confirm('Datei wirklich lÃ¶schen?')) return;
            await fetch(`/api/file/${currentFile}`, { method: 'DELETE' });
            currentFile = null;
            blocks = [];
            blockArea.innerHTML = '';
            await refreshFileList();
        };

        socket.on('file-updated', name => {
            if (name === currentFile) openFile(name);
        });
        socket.on('file-deleted', name => {
            if (name === currentFile) {
                currentFile = null;
                blocks = [];
                blockArea.innerHTML = '';
            }
            refreshFileList();
        });

        function enableInlineRename(li, oldName) {
            if (li.querySelector('input')) return;
            const a = li.querySelector('a');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.className = 'input input-bordered w-full';
            li.replaceChild(input, a);
            input.select();

            // Enter = umbenennen
            const onEnter = async e => {
                if (e.key === 'Enter') {
                    input.removeEventListener('blur', onBlur);
                    input.removeEventListener('keydown', onEnter);

                    const newName = input.value.trim() || oldName;
                    if (newName !== oldName) {
                        await fetch(`/api/file/${oldName}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ _rename: newName })
                        });
                        if (currentFile === oldName) currentFile = newName;
                    }

                    restoreLink(li, newName);
                    refreshFileList();
                }
                if (e.key === 'Escape') {
                    input.removeEventListener('blur', onBlur);
                    input.removeEventListener('keydown', onEnter);
                    restoreLink(li, oldName);
                }
            };

            // Blur = abbrechen (leicht verzÃ¶gert, damit Enterâ€‘Handler zuerst ran kann)
            const onBlur = () => {
                setTimeout(() => {
                    if (li.contains(input)) {
                        input.removeEventListener('blur', onBlur);
                        input.removeEventListener('keydown', onEnter);
                        restoreLink(li, oldName);
                    }
                }, 0);
            };

            input.addEventListener('keydown', onEnter);
            input.addEventListener('blur', onBlur);
        }


        function restoreLink(li, name) {
            const input = li.querySelector('input');
            const a = document.createElement('a');
            a.textContent = name;
            a.className = 'block truncate cursor-pointer';
            if (name === currentFile) a.classList.add('active');
            a.onclick = () => openFile(name);
            li.replaceChild(a, input);
        }

        // â€”â€” Toolbar & Editor â€”â€” 
        function setupToolbar() {
            btnNote.onclick = () => selectMode('note', btnNote);
            btnCheck.onclick = () => selectMode('check', btnCheck);
            btnCode.onclick = () => selectMode('code', btnCode);
            btnAddBlock.onclick = addBlock;

            btnBold.onclick = () => { state.bold = !state.bold; flash(btnBold); };
            selColor.onchange = e => state.color = e.target.value;
            selSize.onchange = e => state.size = e.target.value;
            selLang.onchange = e => state.lang = e.target.value;
        }

        function selectMode(mode, btn) {
            state.mode = mode;
            toolbarBtns.forEach(b => b.classList.remove('btn-active'));
            btn.classList.add('btn-active');
        }

        function flash(btn) {
            btn.classList.add('btn-active');
            setTimeout(() => btn.classList.remove('btn-active'), 200);
        }

        function setupEditor() {
            // Doppelklick auf leeres Canvas
            blockArea.addEventListener('dblclick', e => {
                if (e.target === blockArea) addBlock();
            });
        }

        async function renderBlocks() {
            blockArea.innerHTML = '';
            for (let i = 0; i < blocks.length; i++) {
                const b = blocks[i];
                const wrap = document.createElement('div');
                wrap.className = 'p-2 bg-base-100 rounded shadow flex gap-2';
                wrap.draggable = true;
                wrap.ondragstart = e => e.dataTransfer.setData('text', i);
                wrap.ondrop = e => { e.preventDefault(); moveBlock(+e.dataTransfer.getData('text'), i); };
                wrap.ondragover = e => e.preventDefault();

                if (b.type === 'note') {
                    wrap.append(makeEditable(b.text, v => { b.text = v; debounceSave(); }));
                }
                else if (b.type === 'check') {
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = b.checked || false;
                    cb.onchange = () => { b.checked = cb.checked; debounceSave(); };
                    const div = makeEditable(b.text, v => { b.text = v; });
                    styleCheck(div, b.checked);
                    wrap.append(cb, div);
                }
                else if (b.type === 'code') {
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.className = `language-${b.lang || 'javascript'}`;
                    code.contentEditable = true;
                    code.innerText = b.code || '';
                    code.oninput = () => { b.code = code.innerText; Prism.highlightElement(code); debounceSave(); };
                    pre.append(code); wrap.append(pre);
                    Prism.highlightElement(code);
                }

                // LÃ¶schen-Button
                const del = document.createElement('button');
                del.className = 'btn btn-ghost btn-xs';
                del.textContent = 'ğŸ—‘ï¸';
                del.onclick = () => { blocks.splice(i, 1); renderBlocks(); save(); };
                wrap.append(del);

                blockArea.append(wrap);
            }
        }

        function makeEditable(html, onChange) {
            const div = document.createElement('div');
            div.contentEditable = true;
            div.className = 'flex-1 outline-none';
            div.innerHTML = html || '';
            div.oninput = () => onChange(div.innerHTML);
            return div;
        }

        function styleCheck(el, checked) {
            el.classList.toggle('line-through', checked);
        }

        function moveBlock(src, tgt) {
            if (src === tgt) return;
            blocks.splice(tgt, 0, blocks.splice(src, 1)[0]);
            renderBlocks();
            save();
        }

        function addBlock() {
            let block;
            if (state.mode === 'note') block = { type: 'note', text: '', style: { bold: state.bold, color: state.color, size: state.size } };
            if (state.mode === 'check') block = { type: 'check', text: '', checked: false };
            if (state.mode === 'code') block = { type: 'code', code: '', lang: state.lang };
            blocks.push(block);
            renderBlocks();
            save();
        }

        async function save() {
            if (!currentFile) return;
            await fetch(`/api/file/${currentFile}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(blocks)
            });
        }
        const debounceSave = debounce(save, 700);
        function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); } }  
    </script>




    <script type="module" src="./js/settings.js"></script>
    <!-- <script type="module" src="./js/toolbarCanvas.js"></script>
    <script type="module" src="./js/editor.js"></script>
    <script type="module" src="./js/fileExplorer.js"></script> -->

</body>

</html>